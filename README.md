# 3-е учебное задание по МЛОПС

Выполнил магистрант Литаврин Я.И.

**!!! Внимание !!! Данный скрипт для запуска требует указания идентификационных данных API-токена мессенджера Telegram, так как исходную информацию для работы модели получает из него (парсит наш учебный групповой чат). Свои идентификационные данные я не могу размещать в открытом репозитории, так как это очень чувствительная информация. В случае необходимости, я могу продемонстрировать работоспособность скрипта в онлайн-режиме любым удобным для Вас способом.**

Общий принцип работы конвейера:

Конвейер настроен на ежедневный запуск в 00:01:00 и разделен на 6 последовательных операций:

**task_1:** Производится считывание очередной порции сообщений из отслеживаемого Телеграм-чата. В данном конкретном примере отслеживается учебный общегрупповой чат нашей магистратуры. Количество сообщений, которое считывается - 500 (эмпирически выяснено, что больше указанного количества сообщений за сутки никогда не было). Можно увеличить количество сообщений или поменять ссылку на чат - это задается переменными до объявления функций.

**task_2:** Производится объединение файла с историей сообщений и полученного последнего фрейма из 500 сообщений. Это необходимо, чтобы каждый раз не парсить большое количество сообщений, а для обучения модели использовать файл с историей, но обновлять его при каждом запуске. При объединении дубликаты убираются.

**task_3:** Осуществляется препроцессинг сообщений. Так как модель работает с временными рядами, а полученные сообщения ещё таковыми не являются, переводим их в формат временного ряда. Для этого сутки разбиваются на равномерные отрезки по часу и для каждого из этих отрезков подсчитывается количество сообщений, которые отсылались в этот период. Делается два временных ряда - для общей истории сообщений и для последних суток, сохраняются в отдельные файлы.

**task_4:** Проверяется метрика модели. ***Внимание! сама модель для этого не загружается!*** Мы просто берем предсказание модели, которое было получено при прошлом запуске на будущие сутки (то есть те, которые в настоящий момент наступили) и сравниваем это предсказание с теми данными о количестве сообщений (с разбивкой по часам), которые фактически были отправлены (которые мы спарсили выше). Считаем метрику sMAPE, которую записываем в MLFlow вместе с двумя кортежами - реального количества сообщений и предсказанного.

**task_5:** Если метрика получилась полная хрень (а для моей модели, к сожалению, это обычная ситуация), то переучиваем модель на файле с историей сообщений (переведенном в формат временного ряда), с обновлением за последние сутки. 

**task_6:** С помощью модели делаем предсказание о количестве сообщений в чате для следующих (то есть уже 1 минуту как наступивших) суток. 


**В репозитории также имеется файл юпитерского ноутбука, в котором была попытка провести EDA и выбрать оптимальный алгоритм и гиперпараметры модели. На самом деле это сильно обрезанный вариант, я перебирал многие при выполнении итогового проекта по МОМО, в данном файле указан лучший. К сожалению, даже лучшее из того, что у меня получилось, имеет крайне низкую метрику, но времени на дальнейшие эксперименты, увы, не осталось.**

Ниже привожу некоторые скрины работы моего конвейера в Airflow и его выгрузку в MLflow:
![Image alt](https://github.com/YaRoLit/Airflow_MLflow/raw/main/Screenshots/airflow_4.png)

![Image alt](https://github.com/YaRoLit/Airflow_MLflow/raw/main/Screenshots/airflow.png)

![Image alt](https://github.com/YaRoLit/Airflow_MLflow/raw/main/Screenshots/airflow_2.png)

![Image alt](https://github.com/YaRoLit/Airflow_MLflow/raw/main/Screenshots/airflow_3.png)

![Image alt](https://github.com/YaRoLit/Airflow_MLflow/raw/main/Screenshots/mlflow_1.png)

![Image alt](https://github.com/YaRoLit/Airflow_MLflow/raw/main/Screenshots/mlflow_2.png)
